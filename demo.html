<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchronized Audio Demo</title>
    <link rel="icon" type="image/x-icon" href="static/images/favicon.ico">
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 1200px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 10px;
            color: #3273dc;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        h1 {
            margin: 0 0 10px 0;
            color: #333;
        }
        #controls {
            margin: 20px 0;
            text-align: center;
            width: 100%;
            max-width: 1200px;
        }
        button {
            font-size: 1.2rem;
            padding: 10px 20px;
            cursor: pointer;
            background: #3273dc;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2366d1;
        }
        #visualization-container {
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 1200px;
        }
        /* Style the containers for the visuals */
        #waveform {
            border-bottom: 1px solid #eee;
            width: 100%;
        }
        #piano-roll-container {
            height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        #piano-roll {
            width: 100%;
            display: block;
        }
        #spectrogram {
            height: 200px;
            width: 100%;
            position: relative;
        }
        .playback-cursor {
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background-color: #ff3860;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .playback-cursor.active {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-link">‚Üê Back to Main Page</a>
        <h1>Synchronized Audio & MIDI Visualization</h1>
        <p>This demo plays the clean drum audio with its spectrogram (top) while syncing the playback head with the MIDI file's piano roll (bottom).</p>
    </div>

    <div id="controls">
        <button id="playButton">Play / Pause</button>
    </div>

    <div id="visualization-container">
        <div id="waveform"></div>
        
        <div id="piano-roll-container">
            <div class="playback-cursor" id="midi-cursor"></div>
            <svg id="piano-roll"></svg>
        </div>
        
        <div id="spectrogram" style="position: relative;">
            <div class="playback-cursor" id="spectrogram-cursor"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.23.1/dist/magentamusic.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.23.1/es6/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.23.1/es6/visualizer.js"></script> -->
    
    <script type="module">
        // Import from CDN
        import WaveSurfer from 'https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/wavesurfer.esm.js';
        import Spectrogram from 'https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/plugins/spectrogram.esm.js';

        // --- 1. SET YOUR FILE PATHS HERE ---
        const WAV_FILE_PATH = 'static/clean_10_soul-groove10_102_4-4_bluebird.wav';
        const MIDI_FILE_PATH = 'static/1_funk-groove1_138_beat_4-4.mid';
        // -------------------------------------

        // Global variable for the piano roll visualizer
        let pianoRollViz;

        // --- 2. SETUP THE LEADER (WAVESURFER) ---
        
        const wavesurfer = WaveSurfer.create({
            container: '#waveform',
            waveColor: '#4F4A85',
            progressColor: '#383351',
            url: WAV_FILE_PATH,
            plugins: [
                Spectrogram.create({
                    container: '#spectrogram',
                    labels: true,
                    height: 200,
                }),
            ],
        });

        // --- 3. SETUP THE FOLLOWER (MAGENTA) ---
        
        async function loadPianoRoll() {
            try {
                // Load the MIDI file as a NoteSequence
                const noteSequence = await mm.urlToNoteSequence(MIDI_FILE_PATH);
                
                // Get the container width to match other components
                const containerWidth = document.getElementById('piano-roll-container').clientWidth;
                
                // Create the visualizer with matching width
                pianoRollViz = new mm.PianoRollSVGVisualizer(
                    noteSequence,
                    document.getElementById('piano-roll'),
                    {
                        noteHeight: 6,
                        pixelsPerTimeStep: 30,
                        noteSpacing: 1,
                        noteRGB: '50, 115, 220',
                        activeNoteRGB: '240, 84, 119',
                    }
                );
                
                // Ensure SVG fills the container width
                const svg = document.getElementById('piano-roll');
                svg.setAttribute('width', containerWidth);
                svg.style.width = '100%';
                
            } catch (error) {
                console.error("Failed to load MIDI file or create visualizer:", error);
            }
        }
        
        // --- 4. CONNECT THE CONTROLS & SYNC ---

        function setupSynchronization() {
            // Get the play button and cursor elements
            const playButton = document.getElementById('playButton');
            const midiCursor = document.getElementById('midi-cursor');
            const spectrogramCursor = document.getElementById('spectrogram-cursor');
            const spectrogramContainer = document.getElementById('spectrogram');
            const midiContainer = document.getElementById('piano-roll-container');
            
            playButton.onclick = () => {
                wavesurfer.playPause();
            };

            // This is the core synchronization function
            const syncVisualizations = (currentTime) => {
                // Sync piano roll
                if (pianoRollViz) {
                    pianoRollViz.redraw(currentTime, true);
                }
                
                // Sync cursors
                const duration = wavesurfer.getDuration();
                if (duration > 0) {
                    const percentage = (currentTime / duration) * 100;
                    
                    // Update MIDI cursor
                    midiCursor.style.left = `${percentage}%`;
                    
                    // Update spectrogram cursor
                    spectrogramCursor.style.left = `${percentage}%`;
                }
            };
            
            // Sync on audio playback
            wavesurfer.on('timeupdate', (currentTime) => {
                syncVisualizations(currentTime);
            });

            // Sync on user seeking (clicking/dragging the playhead)
            wavesurfer.on('seek', (currentTime) => {
                syncVisualizations(currentTime);
            });

            // Show/hide cursors on play/pause
            wavesurfer.on('play', () => {
                playButton.textContent = 'Pause';
                midiCursor.classList.add('active');
                spectrogramCursor.classList.add('active');
            });
            wavesurfer.on('pause', () => {
                playButton.textContent = 'Play';
                midiCursor.classList.remove('active');
                spectrogramCursor.classList.remove('active');
            });
            wavesurfer.on('finish', () => {
                playButton.textContent = 'Play';
                midiCursor.classList.remove('active');
                spectrogramCursor.classList.remove('active');
            });

            console.log("Audio, MIDI, and Spectrogram are ready and synchronized.");
        }

        // --- 5. INITIALIZE EVERYTHING ---

        // Wait for wavesurfer to decode the audio
        wavesurfer.on('ready', () => {
            console.log('Waveform ready.');
            // Now that audio is ready, load the piano roll
            loadPianoRoll().then(() => {
                // Once both are loaded, set up the sync
                setupSynchronization();
            });
        });

        wavesurfer.on('error', (err) => {
            console.error('Wavesurfer error:', err);
        });

    </script>
</body>
</html>
