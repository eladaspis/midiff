<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Meta tags for social media banners, these should be filled in appropriatly as they are your "business card" -->
  <!-- Replace the content tag with appropriate information -->
  <meta name="description" content="MiDiff: MIDI-Conditioned Diffusion Models for Drum Audio Enhancement">
  <meta property="og:title" content="MiDiff: MIDI-Conditioned Diffusion Models for Drum Audio Enhancement"/>
  <meta property="og:description" content="MiDiff: MIDI-Conditioned Diffusion Models for Drum Audio Enhancement"/>
  <!-- Path to banner image, should be in the path listed below. Optimal dimenssions are 1200X630-->
  <meta property="og:image" content="static/images/overview.PNG" />
  <meta property="og:image:width" content="1200"/>
  <meta property="og:image:height" content="630"/>


  <meta name="twitter:title" content="MiDiff: MIDI-Conditioned Diffusion Models for Drum Audio Enhancement">
  <meta name="twitter:description" content="MiDiff: MIDI-Conditioned Diffusion Models for Drum Audio Enhancement">
  <!-- Path to banner image, should be in the path listed below. Optimal dimenssions are 1200X600-->
  <meta name="twitter:image" content="static/images/overview.PNG">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Keywords for your paper to be indexed by-->
  <meta name="keywords" content="Audio Denoising, Diffusion Models, CTC Loss">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <title>MiDiff: MIDI-Conditioned Diffusion Models for Drum Audio Enhancement</title>
  <link rel="icon" type="image/x-icon" href="static/images/favicon.ico">
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
  rel="stylesheet">

  <link rel="stylesheet" href="static/css/bulma.min.css">
  <link rel="stylesheet" href="static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
  href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="static/css/index.css">

  <style>
    /* Publication-ready styling */
    body {
      font-family: 'Noto Sans', 'Google Sans', sans-serif;
    }
    
    .publication-title {
      font-family: 'Google Sans', 'Noto Sans', sans-serif;
      font-weight: 600;
    }
    
    .publication-authors {
      margin-bottom: 0.5rem;
    }
    
    .publication-authors a {
      color: #363636;
      text-decoration: none;
    }
    
    .publication-authors a:hover {
      text-decoration: underline;
    }
    
    /* Section spacing */
    .section {
      padding: 3rem 1.5rem;
    }
    
    /* Figure styling */
    figure {
      margin: 1.5rem 0;
    }
    
    figcaption {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.75rem;
    }
    
    /* Force scrollbars to always be visible on spectrogram containers */
    .spectrogram-scroll-container::-webkit-scrollbar {
      height: 12px;
    }
    .spectrogram-scroll-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }
    .spectrogram-scroll-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 6px;
    }
    .spectrogram-scroll-container::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    /* For Firefox */
    .spectrogram-scroll-container {
      scrollbar-width: auto;
      scrollbar-color: #888 #f1f1f1;
    }
    /* Epoch card sizing */
    .epoch-card {
      width: 210px !important;
      min-width: 210px !important;
    }
    
    /* Equation styling */
    .equation-block {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 1.5rem;
      margin: 2rem 0;
      text-align: center;
      font-size: 1.15rem;
    }
    
    /* BibTeX styling */
    #BibTeX pre {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 1rem;
      overflow-x: auto;
    }
    
    #BibTeX code {
      font-size: 0.85rem;
    }
    
    /* Footer styling */
    .footer {
      padding: 3rem 1.5rem;
      background-color: #f5f5f5;
    }
    
    .footer .content p {
      margin-bottom: 0.5rem;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
  <script defer src="static/js/fontawesome.all.min.js"></script>
  <script src="static/js/bulma-carousel.min.js"></script>
  <script src="static/js/bulma-slider.min.js"></script>
  <script src="static/js/index.js"></script>
  <!-- SeeWav for audio waveform visualization -->
  <script src="https://unpkg.com/seewav@1.0.0/dist/seewav.min.js"></script>
  <!-- Chart.js for interactive graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- MIDI Player -->
  <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>
  <!-- MathJax Configuration -->
  <script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']],
      displayMath: [['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };
  </script>
  <!-- MathJax Library -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- MIDI parsing library -->
  <script src="https://cdn.jsdelivr.net/npm/midi-parser-js@4.0.4/dist/midi-parser.min.js"></script>
  <!-- Backup MIDI parser -->
  <script src="https://unpkg.com/midi-file@1.2.4/midi-file.js"></script>
  <!-- Tone.js for audio synthesis -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.58/Tone.js"></script>
  <!-- TensorFlow.js for Magenta -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/1.2.8/tf.min.js"></script>
  <!-- Magenta.js core for Player -->
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.9.0"></script>
  <!-- D3.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/d3@5.7.0/dist/d3.min.js"></script>
  <!-- Web Audio API FFT implementation -->

</head>
<body>


  <section class="hero">
    <div class="hero-body">
      <div class="container is-max-desktop">
        <div class="columns">
          <div class="column has-text-centered">
            <h1 class="title is-1 publication-title">MiDiff: MIDI-Conditioned Diffusion Models for Drum Audio Enhancement</h1>
            <div class="is-size-5 publication-authors">
              <!-- Paper authors -->
              <span class="author-block">
                <a href="#" target="_blank">Elad Aspis</a><sup>1</sup>,
              </span>
              <span class="author-block">
                <a href="#" target="_blank">Sharon Gannot</a><sup>1</sup>
              </span>
            </div>

            <div class="is-size-5 publication-authors">
              <span class="author-block"><sup>1</sup>Bar-Ilan University</span>
            </div>

                  <div class="column has-text-centered">
                    <div class="publication-links">
                      <!-- Paper link -->
                      <span class="link-block">
                        <a href="#" target="_blank" class="external-link button is-normal is-rounded is-dark">
                          <span class="icon">
                            <i class="fas fa-file-pdf"></i>
                          </span>
                          <span>Paper</span>
                        </a>
                      </span>

                      <!-- Github link -->
                      <span class="link-block">
                        <a href="#" target="_blank" class="external-link button is-normal is-rounded is-dark">
                          <span class="icon">
                            <i class="fab fa-github"></i>
                          </span>
                          <span>Code</span>
                        </a>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

<section class="section">
  <div class="container is-widescreen">

    <!-- Abstract -->
    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-3">Abstract</h2>
        <div class="content has-text-justified">
          <p>
            We present MIDI-conditioned diffusion models for drum audio enhancement that leverage symbolic musical information to guide the denoising process. Our method extends SGMSE by incorporating MIDI conditioning through Feature-wise Linear Modulation (FiLM) layers within the NCSNPP U-Net architecture. The MIDI encoder processes piano roll representations to generate conditioning signals that modulate the diffusion model's behavior, enabling musically-informed enhancement decisions. Evaluation on drum audio datasets with (clean, noisy, MIDI) triplets demonstrates improved Frechet VGGish Scores and superior perceptual quality with better preservation of rhythmic structure compared to baseline models.
          </p>
        </div>
      </div>
    </div>

    <!-- Architecture Section with Text and Figures -->
    <div class="columns is-centered" style="margin-top: 3rem;">
      <div class="column is-four-fifths">
        <!-- First Row: Text on Left, MIDI Encoder on Right -->
        <div class="columns is-centered">
          <div class="column is-6">
            <div class="content has-text-justified">
              <h3 class="title is-4">MIDI-Conditioned Architecture</h3>
              <p>
                Our approach builds upon SGMSE (Score-based Generative Models for Speech Enhancement) as the baseline framework, extending it with MIDI conditioning for drum audio enhancement. We utilize the MIDI information as a conditioning signal within the NCSNPP (Noise Conditional Score Network++) U-Net architecture, enabling the model to leverage symbolic musical context during the enhancement process.
              </p>
              <p>
                The core architectural modification involves integrating MIDI conditioning into the NCSNPP residual blocks. Specifically, we add an additional FiLM (Feature-wise Linear Modulation) layer to each residual block, enabling the network to dynamically modulate its behavior based on the MIDI input. The MIDI conditioning is processed through a custom encoder that takes MIDI roll representations and transforms them into continuous embeddings \(\mathbf{h}_{\text{MIDI}} \in \mathbb{R}^d\).
              </p>
              <p>
                The MIDI encoder processes piano roll representations of the drum patterns, capturing note onsets and velocities. This encoder architecture consists of convolutional layers followed by temporal processing stages that extract both local rhythmic patterns and global musical structure. The resulting MIDI embeddings are then used to generate FiLM parameters (\(\gamma\) and \(\beta\)) that modulate the U-Net features at multiple scales, allowing the diffusion model to align audio enhancement with the underlying musical intent and drum performance characteristics.
              </p>
            </div>
          </div>
          <div class="column is-1">
          </div>
          <div class="column is-4" style="margin-top: 4rem;">
            <figure>
              <img src="static/figures/residual_block.png" alt="MIDI-conditioned residual block incorporating FiLM layers" style="width: 100%;">
              <figcaption class="" style="text-align: center;">
                <strong>Figure 1:</strong> MIDI-conditioned residual block incorporating FiLM layers. The MIDI Encoder extracts a latent representation from the raw piano roll input. A Temporal Alignment module then projects these features to match the temporal resolution of the specific U-Net block. Finally, FiLM layers use the aligned MIDI embeddings to modulate the intermediate spectral feature maps via affine transformations.
              </figcaption>
            </figure>
          </div>
        </div>
        
        <!-- Second Row: FiLM Implementation Below -->
        <div class="columns is-centered" style="margin-top: 3rem;">
          <div class="column is-6">
            <div class="content has-text-justified">
              <h3 class="title is-4">Feature-wise Linear Modulation (FiLM)</h3>
              <p>
                FiLM is a powerful conditioning mechanism that modulates the activations of a neural network through feature-wise affine transformations. Given input features \(\mathbf{x}\) and conditioning information (in our case, MIDI embeddings), FiLM applies element-wise scaling and shifting operations:
              </p>
              <p style="text-align: center; background: #f8f9fa; border-left: 4px solid #007bff; padding: 1.5rem; margin: 2rem 0; font-size: 1.15rem;">
                \[\text{FiLM}(\mathbf{x} \mid \gamma, \beta) = \gamma \odot \mathbf{x} + \beta\]
              </p>
              <p>
                where \(\gamma\) and \(\beta\) are learned modulation parameters derived from the MIDI conditioning signal through neural network layers. The scale parameter \(\gamma\) controls the magnitude of features, while the shift parameter \(\beta\) provides an additive bias. This adaptive modulation allows the diffusion model to dynamically adjust its behavior based on the MIDI input.
              </p>
              <p>
                In our architecture, the FiLM parameters are generated from the MIDI encoder output:
              </p>
              <p style="text-align: center; background: #f8f9fa; border-left: 4px solid #28a745; padding: 1.5rem; margin: 2rem 0; font-size: 1.15rem;">
                \[\gamma = f_{\gamma}(\mathbf{h}_{\text{MIDI}}), \quad \beta = f_{\beta}(\mathbf{h}_{\text{MIDI}})\]
              </p>
              <p>
                where \(\mathbf{h}_{\text{MIDI}}\) represents the encoded MIDI features, and \(f_{\gamma}\), \(f_{\beta}\) are learned projection functions. This conditioning mechanism is applied at multiple layers throughout the diffusion U-Net, enabling the network to incorporate MIDI information effectively throughout the denoising process.
              </p>
            </div>
          </div>
          <div class="column is-2">
          </div>

          <div class="column is-3" style="margin-top: 5rem;">
            <figure>
              <img src="static/figures/FiLM_implementation.png" alt="FiLM Implementation" style="width: 100%;">
              <figcaption>
                <strong>Figure 2:</strong> Feature-wise Linear Modulation (FiLM) Implementation
              </figcaption>
            </figure>
          </div>
        </div>
      </div>
    </div>

    <!-- Dataset Section -->
    <div class="columns is-centered" style="margin-top: 3rem;">
      <div class="column is-four-fifths">
        <h3 class="title is-3">Dataset</h3>
        <div class="content has-text-justified">
          <p>
            Our training dataset consists of triplets containing (clean, noisy, MIDI) samples for drum audio enhancement. The clean audio serves as ground truth, noisy versions simulate realistic degradation scenarios, and MIDI data provides symbolic musical context including note onsets, velocities, and timing information.
          </p>
          <p>
            This multimodal structure enables the model to learn relationships between symbolic musical information and audio quality, allowing for musically-informed enhancement decisions. The MIDI component serves as a strong conditioning signal, providing explicit knowledge about drum patterns and timing for the enhancement process.
          </p>
            <p>The following samples provide a direct perceptual comparison. The "Clean Original" and "Noisy Input" are provided as references.</p>
        </div>
      </div>
    </div>

    <div class="content">
    </div>
    
    <!-- Clean, Noisy, and MIDI Reference in One Line -->
    <div class="columns is-centered" style="margin-bottom: 30px;">
      <!-- Clean Audio Reference -->
      <div class="column is-4">
        <div class="box" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
          <div class="level is-mobile" style="margin-bottom: 15px;">
            <div class="level-left">
              <div class="level-item">
                <h4 class="title is-6" style="color: #2c3e50; margin-bottom: 0;">
                  <span class="icon" style="color: #27ae60;">
                    <i class="fas fa-music"></i>
                  </span>
                  Clean Reference Audio
                </h4>
              </div>
            </div>
          </div>
          
          <!-- Compact Spectrogram visualization -->
          <div class="spectrogram-scroll-container" style="margin-bottom: 15px; display: flex; justify-content: flex-start; border: 2px solid #dee2e6; border-radius: 8px; overflow-x: scroll; overflow-y: hidden; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.3); height: 270px; cursor: grab;">
            <img src="static/images/spec_clean.png" alt="Clean Audio Spectrogram" style="height: 265px; width: auto; display: inline-block; max-width: none;">
          </div>
          
          <div class="field">
            <div class="control">
              <audio id="audio-clean" controls style="width: 100%; height: 40px;">
                <source src="static/clean_10_soul-groove10_102_4-4_bluebird.wav" type="audio/wav">
                Your browser does not support the audio element.
              </audio>
            </div>
          </div>
        </div>
      </div>

      <!-- Noisy Audio Reference -->
      <div class="column is-4">
        <div class="box" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 2px solid #ffc107; border-radius: 12px; box-shadow: 0 8px 25px rgba(255,193,7,0.2);">
          <div class="level is-mobile" style="margin-bottom: 15px;">
            <div class="level-left">
              <div class="level-item">
                <h4 class="title is-6" style="color: #856404; margin-bottom: 0;">
                  <span class="icon" style="color: #f39c12;">
                    <i class="fas fa-music"></i>
                  </span>
                  Noisy Input Audio
                </h4>
              </div>
            </div>
          </div>
          
          <!-- Compact Spectrogram visualization -->
          <div class="spectrogram-scroll-container" style="margin-bottom: 15px; display: flex; justify-content: flex-start; border: 2px solid #ffc107; border-radius: 8px; overflow-x: scroll; overflow-y: hidden; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.3); height: 270px; cursor: grab;">
            <img src="static/images/spec_noisy.png" alt="Noisy Audio Spectrogram" style="height: 265px; width: auto; display: inline-block; max-width: none;">
          </div>
          
          <div class="field">
            <div class="control">
              <audio id="audio-noisy" controls style="width: 100%; height: 40px;">
                <source src="static/audio/drummer1_1_funk-groove1_138_beat_4-4_bluebird_noisy.wav" type="audio/wav">
                Your browser does not support the audio element.
              </audio>
            </div>
          </div>
        </div>
      </div>

      <!-- MIDI Input File -->
      <div class="column is-4">
        <div class="box" style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border: 2px solid #28a745; border-radius: 12px; box-shadow: 0 8px 25px rgba(40,167,69,0.2);">
          <div class="level is-mobile" style="margin-bottom: 15px;">
            <div class="level-left">
              <div class="level-item">
                <h4 class="title is-6" style="color: #155724; margin-bottom: 0;">
                  <span class="icon" style="color: #28a745;">
                    <i class="fas fa-file-audio"></i>
                  </span>
                  Condition - MIDI Input File
                </h4>
              </div>
            </div>
          </div>
          
          <!-- MIDI Piano Roll Visualization (Canvas) -->
          <div style="margin-bottom: 15px; display: flex; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #E8E8E8; overflow: hidden;">
            <!-- Drum labels on the left -->
            <canvas id="drum-labels-canvas" style="display: block; height: 265px; width: 85px; border-right: 1px solid rgba(0, 0, 0, 0.1);"></canvas>
            <!-- Scrollable piano roll -->
            <div id="piano-roll-container" style="overflow-x: auto; flex: 1; position: relative;">
              <canvas id="piano-roll-canvas" style="display: block; height: 265px;"></canvas>
            </div>
          </div>
          
          <!-- MIDI Player -->
          <div class="field">
            <div class="control">
              <midi-player
                id="midi-player-main"
                src="static/10_soul-groove10_102_beat_4-4.mid"
                sound-font
                visualizer="#midi-visualizer"
                style="width: 100%; border-radius: 8px; display: block; margin: 0; padding: 0;">
              </midi-player>
            </div>
          </div>
          
          <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.js"></script>
          <script>
            // Real-time MIDI Piano Roll Visualization
            (async function() {
              const player = document.getElementById('midi-player-main');
              const container = document.getElementById('piano-roll-container');
              const canvas = document.getElementById('piano-roll-canvas');
              const ctx = canvas.getContext('2d');
              const labelsCanvas = document.getElementById('drum-labels-canvas');
              const labelsCtx = labelsCanvas.getContext('2d');
              
              // Custom drum map for this specific MIDI file (9 drums)
              const drumNames = {
                36: 'Bass',
                38: 'Snare',
                42: 'HH Close',
                46: 'HH Open',
                43: 'Floor Tom',
                47: 'Mid Tom',
                48: 'High Tom',
                49: 'Crash',
                51: 'Ride'
              };
              
              let midiData = null;
              let allNotes = [];
              let duration = 0;
              // Use only the actual pitches present in the MIDI (9 drums)
              const usedPitches = [36, 38, 42, 46, 43, 47, 48, 49, 51]; // Bass, Snare, HH Close, HH Open, Floor Tom, Mid Tom, High Tom, Crash, Ride
              const pixelsPerSecond = 50; // Scale: 50px per second (more notes visible)
              
              // Set label canvas size
              labelsCanvas.width = 85;
              labelsCanvas.height = 265; // Balanced height for visualization
              
              // Load and parse MIDI file
              try {
                const response = await fetch('static/10_soul-groove10_102_beat_4-4.mid');
                const arrayBuffer = await response.arrayBuffer();
                midiData = await Midi.fromUrl('static/10_soul-groove10_102_beat_4-4.mid');
                
                // Extract all notes from all tracks
                midiData.tracks.forEach(track => {
                  track.notes.forEach(note => {
                    allNotes.push({
                      pitch: note.midi,
                      start: note.time,
                      end: note.time + note.duration,
                      velocity: note.velocity
                    });
                  });
                });
                
                duration = midiData.duration;
                
                // Debug: Show all unique pitches
                const uniquePitches = [...new Set(allNotes.map(n => n.pitch))].sort((a, b) => a - b);
                console.log(`Loaded MIDI: ${allNotes.length} notes, duration: ${duration}s`);
                console.log(`Unique pitches in MIDI:`, uniquePitches);
                console.log(`Using pitch mapping:`, usedPitches);
                
                // Set canvas size
                const canvasWidth = duration * pixelsPerSecond;
                canvas.width = canvasWidth;
                canvas.height = 265; // Balanced height for visualization
                
                // Initial draw
                drawPianoRoll(0);
                drawDrumLabels();
                
                // Animation loop for cursor and scrolling
                function animate() {
                  if (player.playing) {
                    const currentTime = player.currentTime || 0;
                    drawPianoRoll(currentTime);
                    
                    // Auto-scroll to keep cursor centered
                    const cursorX = currentTime * pixelsPerSecond;
                    const containerWidth = container.offsetWidth;
                    container.scrollLeft = cursorX - (containerWidth / 2);
                  }
                  requestAnimationFrame(animate);
                }
                animate();
                
              } catch (error) {
                console.error('Error loading MIDI:', error);
                ctx.fillStyle = '#28a745';
                ctx.font = '16px sans-serif';
                ctx.fillText('Error loading MIDI file', 10, 150);
              }
              
              function drawPianoRoll(currentTime) {
                // Clear canvas with light gray background
                ctx.fillStyle = '#E8E8E8';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const numPitches = usedPitches.length; // 6 pitches
                const pitchHeight = canvas.height / numPitches;
                
                // Draw alternating row backgrounds for better readability
                usedPitches.forEach((pitch, index) => {
                  if (index % 2 === 0) {
                    const y = canvas.height - ((index + 1) * pitchHeight);
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.03)';
                    ctx.fillRect(0, y, canvas.width, pitchHeight);
                  }
                });
                
                // Draw enhanced grid lines
                ctx.strokeStyle = 'rgba(40, 167, 69, 0.15)';
                ctx.lineWidth = 0.5;
                
                // Vertical grid lines (every second) with stronger lines every 4 seconds
                for (let t = 0; t <= duration; t += 1) {
                  const x = t * pixelsPerSecond;
                  if (t % 4 === 0) {
                    ctx.strokeStyle = 'rgba(40, 167, 69, 0.25)';
                    ctx.lineWidth = 1;
                  } else {
                    ctx.strokeStyle = 'rgba(40, 167, 69, 0.1)';
                    ctx.lineWidth = 0.5;
                  }
                  ctx.beginPath();
                  ctx.moveTo(x, 0);
                  ctx.lineTo(x, canvas.height);
                  ctx.stroke();
                }
                
                // Horizontal grid lines between each drum
                ctx.strokeStyle = 'rgba(40, 167, 69, 0.1)';
                ctx.lineWidth = 0.5;
                for (let i = 0; i <= numPitches; i++) {
                  const y = canvas.height - (i * pitchHeight);
                  ctx.beginPath();
                  ctx.moveTo(0, y);
                  ctx.lineTo(canvas.width, y);
                  ctx.stroke();
                }
                
                // Draw all notes with drum-specific color palette
                allNotes.forEach(note => {
                  // Find the index of this pitch in our used pitches
                  const pitchIndex = usedPitches.indexOf(note.pitch);
                  if (pitchIndex === -1) return; // Skip notes not in our list
                  
                  const x = note.start * pixelsPerSecond;
                  const width = Math.max((note.end - note.start) * pixelsPerSecond, 2);
                  const y = canvas.height - ((pitchIndex + 1) * pitchHeight);
                  const height = pitchHeight * 0.85;
                  
                  // Drum-specific color palette - soft pastel colors
                  const drumColors = {
                    36: { r: 126, g: 200, b: 227, name: 'Sky Blue' },         // Bass/Kick
                    38: { r: 255, g: 166, b: 158, name: 'Salmon' },           // Snare
                    42: { r: 162, g: 210, b: 255, name: 'Aqua' },             // Hi-Hat Closed
                    46: { r: 184, g: 242, b: 230, name: 'Mint' },             // Hi-Hat Open
                    43: { r: 160, g: 206, b: 217, name: 'Teal' },             // Floor Tom (Low Tom)
                    47: { r: 224, g: 187, b: 228, name: 'Lilac' },            // Mid Tom
                    48: { r: 255, g: 218, b: 193, name: 'Peach' },            // High Tom
                    49: { r: 253, g: 253, b: 150, name: 'Light Yellow' },     // Crash
                    51: { r: 203, g: 170, b: 203, name: 'Lavender' }          // Ride
                  };
                  
                  const velocity = note.velocity;
                  const isPlaying = currentTime >= note.start && currentTime <= note.end;
                  
                  // Get base color for this drum
                  const baseColor = drumColors[note.pitch] || { r: 100, g: 100, b: 100 };
                  
                  // Adjust brightness and alpha based on velocity
                  const velocityFactor = 0.4 + (velocity * 0.6); // Range from 40% to 100%
                  const r = Math.floor(baseColor.r * velocityFactor);
                  const g = Math.floor(baseColor.g * velocityFactor);
                  const b = Math.floor(baseColor.b * velocityFactor);
                  const alpha = 0.6 + (velocity * 0.4); // Range from 0.6 to 1.0
                  
                  if (isPlaying) {
                    // Highlight currently playing notes with intense glow
                    const glowIntensity = 10 + velocity * 15; // Stronger glow for louder notes
                    ctx.shadowBlur = glowIntensity;
                    ctx.shadowColor = `rgba(${baseColor.r}, ${baseColor.g}, ${baseColor.b}, ${Math.min(alpha + 0.4, 1)})`;
                    
                    // Brighter color when playing (use full base color)
                    const playR = Math.min(255, baseColor.r + 40);
                    const playG = Math.min(255, baseColor.g + 40);
                    const playB = Math.min(255, baseColor.b + 40);
                    
                    const playGradient = ctx.createLinearGradient(x, y, x, y + height);
                    playGradient.addColorStop(0, `rgba(${playR}, ${playG}, ${playB}, ${Math.min(alpha + 0.3, 1)})`);
                    playGradient.addColorStop(1, `rgba(${baseColor.r}, ${baseColor.g}, ${baseColor.b}, ${alpha})`);
                    ctx.fillStyle = playGradient;
                    ctx.strokeStyle = `rgba(${playR}, ${playG}, ${playB}, 1)`;
                    ctx.lineWidth = 1.5 + velocity;
                  } else {
                    ctx.shadowBlur = 0;
                    
                    // Create velocity-based gradient for notes
                    const noteGradient = ctx.createLinearGradient(x, y, x, y + height);
                    noteGradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, ${alpha})`);
                    noteGradient.addColorStop(1, `rgba(${Math.floor(r * 0.7)}, ${Math.floor(g * 0.7)}, ${Math.floor(b * 0.7)}, ${alpha * 0.8})`);
                    ctx.fillStyle = noteGradient;
                    ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, ${alpha * 0.9})`;
                    ctx.lineWidth = 0.5 + velocity * 0.5;
                  }
                  
                  // Draw rounded rectangle for notes
                  const radius = Math.min(2, height / 4);
                  ctx.beginPath();
                  ctx.roundRect(x, y, width, height, radius);
                  ctx.fill();
                  ctx.stroke();
                  ctx.shadowBlur = 0;
                });
                
                // Draw playback cursor with enhanced styling
                if (player.playing) {
                  const cursorX = currentTime * pixelsPerSecond;
                  
                  // Draw glow effect
                  ctx.shadowBlur = 10;
                  ctx.shadowColor = 'rgba(255, 100, 100, 0.6)';
                  
                  // Draw cursor line with gradient
                  const cursorGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                  cursorGradient.addColorStop(0, 'rgba(255, 50, 50, 0.9)');
                  cursorGradient.addColorStop(0.5, 'rgba(255, 80, 80, 1)');
                  cursorGradient.addColorStop(1, 'rgba(255, 50, 50, 0.9)');
                  ctx.strokeStyle = cursorGradient;
                  ctx.lineWidth = 3;
                  ctx.beginPath();
                  ctx.moveTo(cursorX, 0);
                  ctx.lineTo(cursorX, canvas.height);
                  ctx.stroke();
                  ctx.shadowBlur = 0;
                  
                  // Draw time label with background
                  const timeText = `${currentTime.toFixed(1)}s`;
                  ctx.font = 'bold 11px sans-serif';
                  const textWidth = ctx.measureText(timeText).width;
                  
                  // Background for time label
                  ctx.fillStyle = 'rgba(255, 50, 50, 0.9)';
                  ctx.fillRect(cursorX + 3, 8, textWidth + 8, 16);
                  
                  // Time text
                  ctx.fillStyle = '#ffffff';
                  ctx.fillText(timeText, cursorX + 7, 19);
                }
              }
              
              function drawDrumLabels() {
                // Clear labels canvas with light gray background
                labelsCtx.fillStyle = '#E8E8E8';
                labelsCtx.fillRect(0, 0, labelsCanvas.width, labelsCanvas.height);
                
                const numPitches = usedPitches.length; // 6 pitches
                const pitchHeight = labelsCanvas.height / numPitches;
                
                // Draw alternating row backgrounds
                usedPitches.forEach((pitch, index) => {
                  if (index % 2 === 0) {
                    const y = labelsCanvas.height - ((index + 1) * pitchHeight);
                    labelsCtx.fillStyle = 'rgba(0, 0, 0, 0.03)';
                    labelsCtx.fillRect(0, y, labelsCanvas.width, pitchHeight);
                  }
                });
                
                labelsCtx.font = 'bold 10px sans-serif';
                labelsCtx.textAlign = 'right';
                labelsCtx.textBaseline = 'middle';
                
                usedPitches.forEach((pitch, index) => {
                  const y = labelsCanvas.height - ((index + 0.5) * pitchHeight);
                  
                  // Determine label text
                  let label = drumNames[pitch] || `${pitch}`;
                  
                  // Draw subtle horizontal line
                  labelsCtx.strokeStyle = 'rgba(40, 167, 69, 0.15)';
                  labelsCtx.lineWidth = 0.5;
                  labelsCtx.beginPath();
                  labelsCtx.moveTo(0, y);
                  labelsCtx.lineTo(labelsCanvas.width, y);
                  labelsCtx.stroke();
                  
                  // Draw label text with subtle shadow for better readability
                  labelsCtx.shadowBlur = 2;
                  labelsCtx.shadowColor = 'rgba(255, 255, 255, 0.5)';
                  labelsCtx.fillStyle = '#000000';
                  labelsCtx.fillText(label, labelsCanvas.width - 4, y);
                  labelsCtx.shadowBlur = 0;
                });
              }
            })();
          </script>
          
          <!-- <div class="field">
            <div class="control">
              <a href="static/10_soul-groove10_102_beat_4-4.mid" download class="button is-success is-fullwidth">
                <span class="icon">
                  <i class="fas fa-download"></i>
                </span>
                <span>Download MIDI</span>
              </a>
            </div>
          </div> -->
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="columns is-centered" style="margin-top: 3rem;">
      <div class="column is-four-fifths">
        <h2 class="title is-3">Results</h2>
        <div class="content">
          <p>To quantitatively evaluate performance, we calculated standard audio quality metrics. The Frechet VGGish Score measures the similarity between distributions of embeddings from the generated audio and the ground truth clean audio. <strong>A lower score indicates higher similarity to the clean audio.</strong></p>
        </div>
        
        <figure style="margin-top: 2rem;">
          <div style="position: relative; width: 100%; height: 400px; margin: 20px 0;">
            <div style="position: absolute; top: 10px; right: 10px; z-index: 10; background: white; padding: 8px 12px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
              <label class="checkbox" style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; color: #4a4a4a;">
                <input type="checkbox" id="logScaleToggle" onchange="toggleLogScale()" checked style="cursor: pointer;">
                <span>Log Scale</span>
              </label>
            </div>
            <canvas id="frechetChart"></canvas>
          </div>
          <figcaption style="text-align: center;"><strong>Figure 3:</strong> Interactive Frechet VGGish Score vs. Epochs for Baseline vs. Midi Conditioned models.</figcaption>
        </figure>
        
      </div>
    </div>

    <div class="columns is-centered" style="margin-top: 3rem;">
      <div class="column is-four-fifths">
        <h2 class="title is-3">Audio Samples</h2>
        <p class="content has-text-justified" style="margin-bottom: 1.5rem;">Compare the audio outputs of our baseline model and MIDI-conditioned model across different training epochs. Use the interactive tool below to select any two outputs for side-by-side comparison.</p>
      </div>
    </div>

    <!-- Interactive Epoch Comparison Tool -->
    <div class="columns is-centered">
      <div class="column is-full" style="max-width: 1200px; padding: 0 2rem;">
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid #dee2e6;">
          <h4 class="title is-5" style="margin-bottom: 1rem; color: #495057;">
            <span class="icon" style="color: #3b82f6;"><i class="fas fa-sliders-h"></i></span>
            Epoch Comparison Tool
          </h4>
          <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 1rem;">Select any two model outputs to compare side-by-side. Scrolling is synchronized for easy comparison.</p>
          
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
            <div style="flex: 1; min-width: 200px;">
              <label style="font-weight: 600; font-size: 0.85rem; color: #495057; margin-bottom: 0.5rem; display: block;">Left Spectrogram:</label>
              <select id="epoch-compare-left" onchange="updateEpochComparison('left')" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #ced4da; font-size: 0.9rem;">
                <optgroup label="Baseline Model">
                  <option value="baseline_0">Baseline - Epoch 0</option>
                  <option value="baseline_10">Baseline - Epoch 10</option>
                  <option value="baseline_20">Baseline - Epoch 20</option>
                  <option value="baseline_30" selected>Baseline - Epoch 30</option>
                  <option value="baseline_40">Baseline - Epoch 40</option>
                  <option value="baseline_50">Baseline - Epoch 50</option>
                </optgroup>
                <optgroup label="MIDI Conditioned Model">
                  <option value="midi_0">MIDI Cond. - Epoch 0</option>
                  <option value="midi_10">MIDI Cond. - Epoch 10</option>
                  <option value="midi_20">MIDI Cond. - Epoch 20</option>
                  <option value="midi_30">MIDI Cond. - Epoch 30</option>
                  <option value="midi_40">MIDI Cond. - Epoch 40</option>
                  <option value="midi_50">MIDI Cond. - Epoch 50</option>
                </optgroup>
              </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
              <label style="font-weight: 600; font-size: 0.85rem; color: #495057; margin-bottom: 0.5rem; display: block;">Right Spectrogram:</label>
              <select id="epoch-compare-right" onchange="updateEpochComparison('right')" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #ced4da; font-size: 0.9rem;">
                <optgroup label="Baseline Model">
                  <option value="baseline_0">Baseline - Epoch 0</option>
                  <option value="baseline_10">Baseline - Epoch 10</option>
                  <option value="baseline_20">Baseline - Epoch 20</option>
                  <option value="baseline_30">Baseline - Epoch 30</option>
                  <option value="baseline_40">Baseline - Epoch 40</option>
                  <option value="baseline_50">Baseline - Epoch 50</option>
                </optgroup>
                <optgroup label="MIDI Conditioned Model">
                  <option value="midi_0">MIDI Cond. - Epoch 0</option>
                  <option value="midi_10">MIDI Cond. - Epoch 10</option>
                  <option value="midi_20">MIDI Cond. - Epoch 20</option>
                  <option value="midi_30" selected>MIDI Cond. - Epoch 30</option>
                  <option value="midi_40">MIDI Cond. - Epoch 40</option>
                  <option value="midi_50">MIDI Cond. - Epoch 50</option>
                </optgroup>
              </select>
            </div>
          </div>
          
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <!-- Left comparison panel -->
            <div style="flex: 1; min-width: 300px; background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
              <div id="epoch-compare-left-label" style="text-align: center; font-weight: 600; margin-bottom: 8px; color: #c92a2a;">Baseline - Epoch 30</div>
              <div id="epoch-compare-left-container" class="epoch-compare-sync-group" style="border: 2px solid #ff6b6b; border-radius: 8px; overflow-x: scroll; overflow-y: hidden; white-space: nowrap; height: 160px; cursor: grab;">
                <img id="epoch-compare-left-img" src="static/images/baseline_epoch_30.png" alt="Left Comparison" class="epoch-compare-img" style="height: 156px; width: auto; display: inline-block; max-width: none;">
              </div>
              <audio id="epoch-compare-left-audio" controls style="width: 100%; height: 36px; margin-top: 8px;">
                <source id="epoch-compare-left-audio-src" src="static/audio/baseline/version_83/enhancement/use_midi=False_epoch_30/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav" type="audio/wav">
              </audio>
            </div>
            
            <!-- Right comparison panel -->
            <div style="flex: 1; min-width: 300px; background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
              <div id="epoch-compare-right-label" style="text-align: center; font-weight: 600; margin-bottom: 8px; color: #1e40af;">MIDI Cond. - Epoch 30</div>
              <div id="epoch-compare-right-container" class="epoch-compare-sync-group" style="border: 2px solid #3b82f6; border-radius: 8px; overflow-x: scroll; overflow-y: hidden; white-space: nowrap; height: 160px; cursor: grab;">
                <img id="epoch-compare-right-img" src="static/images/midi_film_conditioned_epoch_30.png" alt="Right Comparison" class="epoch-compare-img" style="height: 156px; width: auto; display: inline-block; max-width: none;">
              </div>
              <audio id="epoch-compare-right-audio" controls style="width: 100%; height: 36px; margin-top: 8px;">
                <source id="epoch-compare-right-audio-src" src="static/audio/midi_conditioned/version_86/enhancement/use_midi=True_epoch_30/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav" type="audio/wav">
              </audio>
            </div>
          </div>
          
          <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; align-items: center;">
            <button id="epoch-compare-sync-btn" onclick="toggleEpochCompareSync()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;">
              <i class="fas fa-link"></i> Sync Scrolling: ON
            </button>
            
            <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 6px 12px; border-radius: 6px; border: 1px solid #ced4da;">
              <span style="font-weight: 600; font-size: 0.85rem; color: #495057;"><i class="fas fa-search"></i> Zoom:</span>
              <button onclick="zoomEpochCompare(-0.25)" style="width: 32px; height: 32px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; cursor: pointer; font-size: 1.1rem; font-weight: bold;">âˆ’</button>
              <span id="epoch-compare-zoom-level" style="min-width: 50px; text-align: center; font-weight: 600; color: #495057;">100%</span>
              <button onclick="zoomEpochCompare(0.25)" style="width: 32px; height: 32px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; cursor: pointer; font-size: 1.1rem; font-weight: bold;">+</button>
              <button onclick="resetEpochCompareZoom()" style="padding: 4px 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Reset</button>
            </div>
          </div>
          
          <p style="font-size: 0.8rem; color: #6c757d; text-align: center; margin-top: 0.75rem;"><i class="fas fa-info-circle"></i> Tip: Use mouse wheel while holding <kbd style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; border: 1px solid #ced4da;">Ctrl</kbd> to zoom, or scroll horizontally to pan.</p>
        </div>

      </div>
    </div>

    <script>
    // Epoch Comparison Tool Data
    const epochCompareData = {
      baseline_0: {
        label: 'Baseline - Epoch 0',
        img: 'static/images/baseline_epoch_0.png',
        audio: 'static/audio/baseline/version_83/enhancement/use_midi=False_epoch_0/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#c92a2a',
        borderColor: '#ff6b6b'
      },
      baseline_10: {
        label: 'Baseline - Epoch 10',
        img: 'static/images/baseline_epoch_10.png',
        audio: 'static/audio/baseline/version_83/enhancement/use_midi=False_epoch_10/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#c92a2a',
        borderColor: '#ff6b6b'
      },
      baseline_20: {
        label: 'Baseline - Epoch 20',
        img: 'static/images/baseline_epoch_20.png',
        audio: 'static/audio/baseline/version_83/enhancement/use_midi=False_epoch_20/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#c92a2a',
        borderColor: '#ff6b6b'
      },
      baseline_30: {
        label: 'Baseline - Epoch 30',
        img: 'static/images/baseline_epoch_30.png',
        audio: 'static/audio/baseline/version_83/enhancement/use_midi=False_epoch_30/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#c92a2a',
        borderColor: '#ff6b6b'
      },
      baseline_40: {
        label: 'Baseline - Epoch 40',
        img: 'static/images/baseline_epoch_40.png',
        audio: 'static/audio/baseline/version_83/enhancement/use_midi=False_epoch_40/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#c92a2a',
        borderColor: '#ff6b6b'
      },
      baseline_50: {
        label: 'Baseline - Epoch 50',
        img: 'static/images/baseline_epoch_50.png',
        audio: 'static/audio/baseline/version_83/enhancement/use_midi=False_epoch_50/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#c92a2a',
        borderColor: '#ff6b6b'
      },
      midi_0: {
        label: 'MIDI Cond. - Epoch 0',
        img: 'static/images/midi_film_conditioned_epoch_0.png',
        audio: 'static/audio/midi_conditioned/version_86/enhancement/use_midi=True_epoch_0/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#1e40af',
        borderColor: '#3b82f6'
      },
      midi_10: {
        label: 'MIDI Cond. - Epoch 10',
        img: 'static/images/midi_film_conditioned_epoch_10.png',
        audio: 'static/audio/midi_conditioned/version_86/enhancement/use_midi=True_epoch_10/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#1e40af',
        borderColor: '#3b82f6'
      },
      midi_20: {
        label: 'MIDI Cond. - Epoch 20',
        img: 'static/images/midi_film_conditioned_epoch_20.png',
        audio: 'static/audio/midi_conditioned/version_86/enhancement/use_midi=True_epoch_20/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#1e40af',
        borderColor: '#3b82f6'
      },
      midi_30: {
        label: 'MIDI Cond. - Epoch 30',
        img: 'static/images/midi_film_conditioned_epoch_30.png',
        audio: 'static/audio/midi_conditioned/version_86/enhancement/use_midi=True_epoch_30/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#1e40af',
        borderColor: '#3b82f6'
      },
      midi_40: {
        label: 'MIDI Cond. - Epoch 40',
        img: 'static/images/midi_film_conditioned_epoch_40.png',
        audio: 'static/audio/midi_conditioned/version_86/enhancement/use_midi=True_epoch_40/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#1e40af',
        borderColor: '#3b82f6'
      },
      midi_50: {
        label: 'MIDI Cond. - Epoch 50',
        img: 'static/images/midi_film_conditioned_epoch_50.png',
        audio: 'static/audio/midi_conditioned/version_86/enhancement/use_midi=True_epoch_50/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav',
        color: '#1e40af',
        borderColor: '#3b82f6'
      }
    };

    let epochCompareSyncEnabled = true;
    let epochCompareZoomLevel = 1.0;
    const EPOCH_COMPARE_MIN_ZOOM = 1.0;
    const EPOCH_COMPARE_MAX_ZOOM = 4.0;

    function updateEpochComparison(side) {
      const selectId = `epoch-compare-${side}`;
      const select = document.getElementById(selectId);
      const value = select.value;
      const data = epochCompareData[value];
      
      if (data) {
        document.getElementById(`epoch-compare-${side}-label`).textContent = data.label;
        document.getElementById(`epoch-compare-${side}-label`).style.color = data.color;
        document.getElementById(`epoch-compare-${side}-img`).src = data.img;
        document.getElementById(`epoch-compare-${side}-container`).style.borderColor = data.borderColor;
        
        const audio = document.getElementById(`epoch-compare-${side}-audio`);
        const audioSrc = document.getElementById(`epoch-compare-${side}-audio-src`);
        audioSrc.src = data.audio;
        audio.load();
      }
    }

    function toggleEpochCompareSync() {
      epochCompareSyncEnabled = !epochCompareSyncEnabled;
      const btn = document.getElementById('epoch-compare-sync-btn');
      if (epochCompareSyncEnabled) {
        btn.innerHTML = '<i class="fas fa-link"></i> Sync Scrolling: ON';
        btn.style.background = '#3b82f6';
      } else {
        btn.innerHTML = '<i class="fas fa-unlink"></i> Sync Scrolling: OFF';
        btn.style.background = '#6c757d';
      }
    }

    function zoomEpochCompare(delta) {
      epochCompareZoomLevel = Math.max(EPOCH_COMPARE_MIN_ZOOM, Math.min(EPOCH_COMPARE_MAX_ZOOM, epochCompareZoomLevel + delta));
      applyEpochCompareZoom();
    }

    function resetEpochCompareZoom() {
      epochCompareZoomLevel = 1.0;
      applyEpochCompareZoom();
    }

    function applyEpochCompareZoom() {
      document.getElementById('epoch-compare-zoom-level').textContent = Math.round(epochCompareZoomLevel * 100) + '%';
      
      document.querySelectorAll('.epoch-compare-img').forEach(img => {
        img.style.height = (156 * epochCompareZoomLevel) + 'px';
      });
      
      document.querySelectorAll('.epoch-compare-sync-group').forEach(container => {
        container.style.height = (160 * epochCompareZoomLevel) + 'px';
      });
    }

    // Setup synchronized scrolling for epoch comparison tool
    document.addEventListener('DOMContentLoaded', function() {
      const epochCompareContainers = document.querySelectorAll('.epoch-compare-sync-group');
      let isEpochCompareScrolling = false;

      epochCompareContainers.forEach(container => {
        container.addEventListener('scroll', function() {
          if (!epochCompareSyncEnabled || isEpochCompareScrolling) return;
          isEpochCompareScrolling = true;
          
          const scrollRatio = this.scrollLeft / Math.max(1, this.scrollWidth - this.clientWidth);
          
          epochCompareContainers.forEach(other => {
            if (other !== this) {
              const maxScroll = other.scrollWidth - other.clientWidth;
              other.scrollLeft = scrollRatio * maxScroll;
            }
          });
          
          setTimeout(() => { isEpochCompareScrolling = false; }, 10);
        });

        // Drag to scroll
        let isDragging = false;
        let startX, scrollLeft;

        container.addEventListener('mousedown', (e) => {
          isDragging = true;
          container.style.cursor = 'grabbing';
          startX = e.pageX - container.offsetLeft;
          scrollLeft = container.scrollLeft;
        });

        container.addEventListener('mouseleave', () => {
          isDragging = false;
          container.style.cursor = 'grab';
        });

        container.addEventListener('mouseup', () => {
          isDragging = false;
          container.style.cursor = 'grab';
        });

        container.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          e.preventDefault();
          const x = e.pageX - container.offsetLeft;
          const walk = (x - startX) * 1.5;
          container.scrollLeft = scrollLeft - walk;
        });

        // Ctrl + wheel to zoom
        container.addEventListener('wheel', function(e) {
          if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoomEpochCompare(delta);
          }
        }, { passive: false });
      });
    });
    </script>
          
    <div class="columns is-centered">
      <div class="column is-four-fifths">
        <div class="content has-text-justified" style="margin: 1rem 0 1.5rem 0;">
          
          <!-- Classifier-Free Guidance Section -->
          <h2 class="title is-3">Classifier-Free Guidance</h2>
          <p>
            Classifier-Free Guidance (CFG) is a technique that controls the strength of conditioning during inference by interpolating between conditional and unconditional predictions. The guidance scale \(w\) determines how strongly the model follows the MIDI Conditioning.
          </p>
          
          <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; border: 2px solid #c084fc;">
            <h5 class="title is-6" style="margin-bottom: 1rem; color: #7c3aed;">
              <span class="icon" style="color: #9333ea;"><i class="fas fa-sliders-h"></i></span>
              Interactive CFG Player
            </h5>
            
            <!-- Slider Control -->
            <div style="background: white; border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <label style="font-weight: 600; color: #495057; min-width: 120px;">Guidance Scale:</label>
                <div style="flex: 1; min-width: 250px; position: relative;">
                  <input type="range" id="cfg-slider" min="0" max="3" step="0.1" value="1.0" 
                         style="width: 100%; height: 8px; cursor: pointer; accent-color: #9333ea;">
                  <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 0.75rem; color: #6c757d; position: relative;">
                    <span style="position: absolute; left: 0;">\(w=0\)</span>
                    <span style="position: absolute; left: 33%; transform: translateX(-50%);">\(w=1\)</span>
                    <span style="position: absolute; left: 66%; transform: translateX(-50%);">\(w=2\)</span>
                    <span style="position: absolute; left: 99%; transform: translateX(-50%);">\(w=3\)</span>


                  </div>
                  <!-- Tick marks for available files -->
                  <div style="position: absolute; top: 0; left: 0; right: 0; height: 8px; pointer-events: none;">
                    <div style="position: absolute; left: 0%; width: 2px; height: 12px; background: #e74c3c; top: -2px;" title="Baseline (w=0)"></div>
                    <div style="position: absolute; left: 33.33%; width: 2px; height: 12px; background: #27ae60; transform: translateX(-50%); top: -2px;" title="w=1"></div>
                    <div style="position: absolute; left: 66.66%; width: 2px; height: 12px; background: #3498db; transform: translateX(-50%); top: -2px;" title="w=2"></div>
                    <div style="position: absolute; left: 100%; width: 2px; height: 12px; background: #9333ea; transform: translateX(-100%); top: -2px;" title="w=3"></div>
                  </div>
                </div>
                <div id="cfg-value-display" style="min-width: 80px; text-align: center; padding: 8px 16px; background: #27ae60; color: white; border-radius: 20px; font-weight: 700; font-size: 1.1rem;">
                  \(w = 1\)
                </div>
              </div>
              <p style="font-size: 0.75rem; color: #9333ea; margin-top: 0.75rem; text-align: center;">
                <i class="fas fa-music"></i> Available samples at: <strong>(w=0) (Midiff) </strong>, <strong>\(w=1\)</strong>, <strong>\(w=2\)</strong>, <strong>\(w=3\)</strong>
              </p>
            </div>
            
            <!-- Spectrogram Display -->
            <div style="background: white; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <div id="cfg-spectrogram-container" style="border: 2px solid #c084fc; border-radius: 8px; overflow: hidden; background: #1a1a2e;">
                <img id="cfg-spectrogram-img" src="static/images/cfg_w_1.0.png" alt="CFG Spectrogram" style="width: 100%; height: auto; display: block;">
              </div>
              <div id="cfg-spectrogram-label" style="text-align: center; margin-top: 0.5rem; font-weight: 600; color: #27ae60;">
                Spectrogram: \(w = 1\)
              </div>
            </div>
            
            <!-- Audio Player Container with preloaded audio elements -->
            <div style="background: white; border-radius: 10px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div id="cfg-audio-container" style="flex: 1; min-width: 250px;">
                  <!-- Preloaded audio elements - only one visible at a time -->
                  <audio id="cfg-audio-0" preload="auto" style="width: 100%; height: 50px; display: none;">
                    <source src="static/audio/baseline/version_83/enhancement/use_midi=False_epoch_50/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav" type="audio/wav">
                  </audio>
                  <audio id="cfg-audio-1" controls preload="auto" style="width: 100%; height: 50px;">
                    <source src="static/audio/midi_conditioned/cfg/w_1.0/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav" type="audio/wav">
                  </audio>
                  <audio id="cfg-audio-2" preload="auto" style="width: 100%; height: 50px; display: none;">
                    <source src="static/audio/midi_conditioned/cfg/w_2.0/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav" type="audio/wav">
                  </audio>
                  <audio id="cfg-audio-3" preload="auto" style="width: 100%; height: 50px; display: none;">
                    <source src="static/audio/midi_conditioned/cfg/w_3.0/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav" type="audio/wav">
                  </audio>
                </div>
                <div id="cfg-description" style="min-width: 200px; padding: 10px 15px; background: #f0fdf4; border-left: 4px solid #27ae60; border-radius: 4px; font-size: 0.9rem;">
                  <strong style="color: #27ae60;">Standard Conditioning</strong><br>
                  <span style="color: #6c757d;">Normal MIDI conditioning strength</span>
                </div>
              </div>
            </div>
            
            <p style="font-size: 0.85rem; color: #6c757d; margin-top: 1rem; text-align: center;">
              <i class="fas fa-bolt"></i> Instant switching! All audio files are preloaded for seamless comparison.
            </p>
          </div>
          
          <script>
          (function() {
            // CFG configurations
            const cfgConfigs = {
              0: { label: 'Baseline', spec: 'static/images/cfg_baseline.png', audioId: 'cfg-audio-0' },
              1: { label: '\\(w = 1\\)', spec: 'static/images/cfg_w_1.0.png', audioId: 'cfg-audio-1' },
              2: { label: '\\(w = 2\\)', spec: 'static/images/cfg_w_2.0.png', audioId: 'cfg-audio-2' },
              3: { label: '\\(w = 3\\)', spec: 'static/images/cfg_w_3.0.png', audioId: 'cfg-audio-3' }
            };
            
            const availableW = [0, 1, 2, 3];
            
            function getColorForW(w) {
              if (w === 0) return '#e74c3c';
              if (w <= 1.5) return '#27ae60';
              if (w <= 2.5) return '#3498db';
              return '#9333ea';
            }
            
            function getBgColorForW(w) {
              if (w === 0) return '#fef2f2';
              if (w <= 1.5) return '#f0fdf4';
              if (w <= 2.5) return '#eff6ff';
              return '#faf5ff';
            }
            
            function getDescriptionForW(w) {
              if (w === 0) return { title: 'No MIDI Conditioning', desc: 'Baseline model without MIDI input' };
              if (w <= 1.5) return { title: 'Standard Conditioning', desc: 'Normal MIDI conditioning strength' };
              if (w <= 2.5) return { title: 'Strong Conditioning', desc: 'Amplified MIDI conditioning' };
              return { title: 'Maximum Conditioning', desc: 'Highly amplified MIDI conditioning' };
            }
            
            function findClosestW(targetW) {
              let closest = availableW[0];
              let minDiff = Math.abs(targetW - closest);
              for (const w of availableW) {
                const diff = Math.abs(targetW - w);
                if (diff < minDiff) {
                  minDiff = diff;
                  closest = w;
                }
              }
              return closest;
            }
            
            const slider = document.getElementById('cfg-slider');
            const valueDisplay = document.getElementById('cfg-value-display');
            const description = document.getElementById('cfg-description');
            const spectrogramImg = document.getElementById('cfg-spectrogram-img');
            const spectrogramLabel = document.getElementById('cfg-spectrogram-label');
            
            // Get all audio elements
            const audioElements = {};
            for (const w of availableW) {
              audioElements[w] = document.getElementById(cfgConfigs[w].audioId);
            }
            
            let currentW = 1; // Start at w=1.0
            let activeAudio = audioElements[1];
            
            // Force all audio elements to load immediately
            for (const w of availableW) {
              audioElements[w].load();
            }
            
            slider.addEventListener('input', function() {
              const sliderW = parseFloat(this.value);
              const closestW = findClosestW(sliderW);
              const config = cfgConfigs[closestW];
              const color = getColorForW(sliderW);
              const bgColor = getBgColorForW(sliderW);
              const descInfo = getDescriptionForW(sliderW);
              
              // Update display with actual slider value (LaTeX)
              valueDisplay.innerHTML = sliderW === 0 ? 'Baseline' : `\\(w = ${sliderW.toFixed(1)}\\)`;
              valueDisplay.style.background = color;
              if (window.MathJax) MathJax.typeset([valueDisplay]);
              
              // Update description
              description.style.background = bgColor;
              description.style.borderLeftColor = color;
              description.innerHTML = `<strong style="color: ${color};">${descInfo.title}</strong><br><span style="color: #6c757d;">${descInfo.desc}</span>`;
              
              // Update spectrogram label (LaTeX)
              spectrogramLabel.innerHTML = `Spectrogram: ${config.label}`;
              spectrogramLabel.style.color = color;
              if (window.MathJax) MathJax.typeset([spectrogramLabel]);
              
              // Only switch audio if we're at a different w value
              if (closestW !== currentW) {
                const wasPlaying = !activeAudio.paused;
                const savedTime = activeAudio.currentTime;
                
                // Pause old audio but remember its time
                activeAudio.pause();
                activeAudio.style.display = 'none';
                activeAudio.removeAttribute('controls');
                
                // Switch to new audio
                const newAudio = audioElements[closestW];
                newAudio.style.display = 'block';
                newAudio.setAttribute('controls', 'controls');
                
                // Update spectrogram
                spectrogramImg.src = config.spec;
                
                // Set time on new audio - wrapped in try/catch and using a small delay
                setTimeout(() => {
                  newAudio.currentTime = savedTime;
                  if (wasPlaying) {
                    newAudio.play().catch(() => {});
                  }
                }, 50);
                
                activeAudio = newAudio;
                currentW = closestW;
              }
            });
            
            // Snap to nearest available config on mouse up
            slider.addEventListener('change', function() {
              const sliderW = parseFloat(this.value);
              const closestW = findClosestW(sliderW);
              this.value = closestW;
              
              // Trigger input event to update display
              this.dispatchEvent(new Event('input'));
            });
          })();
          </script>
          
          <!-- CFG Video Comparison -->
          <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h5 class="title is-6" style="margin-bottom: 1rem; color: #7c3aed;">
              <span class="icon" style="color: #9333ea;"><i class="fas fa-video"></i></span>
              CFG Comparison Video
            </h5>
            <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 1rem;">
              Watch how different guidance scales affect the audio enhancement. The active section is highlighted while others are dimmed.
            </p>
            <div style="border: 2px solid #c084fc; border-radius: 8px; overflow: hidden; background: #1a1a2e;">
              <video controls style="width: 100%; display: block;" preload="metadata">
                <source src="cfg_composite_analysis_16k.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div style="display: flex; justify-content: space-around; margin-top: 0.75rem; font-size: 0.8rem; color: #6c757d;">
              <span><strong style="color: #e74c3c;">â—</strong> Baseline (0-2.5s)</span>
              <span><strong style="color: #27ae60;">â—</strong> w=1 (2.5-5s)</span>
              <span><strong style="color: #3498db;">â—</strong> w=2 (5-7.5s)</span>
              <span><strong style="color: #9333ea;">â—</strong> w=3 (7.5-10s)</span>
            </div>
          </div>
        </div>
      </div>
    </div>
          
    <div class="columns is-centered">
      <div class="column is-four-fifths">
        <div class="content has-text-justified" style="margin: 1rem 0 1.5rem 0;">
          <h2 class="title is-3">Ablation Studies</h2>
          
          <!-- Impact of MIDI Velocity Information -->
          <h3 class="title is-4">Impact of MIDI Velocity Information</h3>
          <p>
            To assess the impact of MIDI velocity information on model performance, we conducted an ablation study comparing two variants of our MIDI-conditioned diffusion model: one utilizing full MIDI data including velocity, and another using MIDI data with velocity information removed (i.e., all note velocities set to a constant value).
          </p>
          <figure style="margin-top: 1.25rem;">
            <div style="position: relative; width: 100%; height: 380px; margin: 12px 0;">
              <canvas id="velocityAblationChart"></canvas>
            </div>
            <figcaption style="text-align: center;">
              <strong>Figure 4:</strong> Ablation study on velocity representation showing FAD scores for different configurations.
            </figcaption>
          </figure>
        </div>

        <!-- Spectrogram Comparison Tool -->
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem; border: 2px solid #dee2e6;">
          <h5 class="title is-6" style="margin-bottom: 1rem; color: #495057;">
            <span class="icon" style="color: #3b82f6;"><i class="fas fa-sliders-h"></i></span>
            Spectrogram Comparison Tool
          </h5>
          <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 1rem;">Select two spectrograms to compare side-by-side. Scrolling is synchronized for easy comparison.</p>
          
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
            <div style="flex: 1; min-width: 200px;">
              <label style="font-weight: 600; font-size: 0.85rem; color: #495057; margin-bottom: 0.5rem; display: block;">Left Spectrogram:</label>
              <select id="compare-left" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #ced4da; font-size: 0.9rem;">
                <option value="midiff">MiDiff (Full MIDI)</option>
                <option value="v0">Velocity 0</option>
                <option value="v1">Velocity 1</option>
                <option value="v20">Velocity 20</option>
                <option value="v40">Velocity 40</option>
                <option value="v60">Velocity 60</option>
                <option value="v80">Velocity 80</option>
                <option value="v100">Velocity 100</option>
                <option value="v127" selected>Velocity 127</option>
              </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
              <label style="font-weight: 600; font-size: 0.85rem; color: #495057; margin-bottom: 0.5rem; display: block;">Right Spectrogram:</label>
              <select id="compare-right" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #ced4da; font-size: 0.9rem;">
                <option value="midiff" selected>MiDiff (Full MIDI)</option>
                <option value="v0">Velocity 0</option>
                <option value="v1">Velocity 1</option>
                <option value="v20">Velocity 20</option>
                <option value="v40">Velocity 40</option>
                <option value="v60">Velocity 60</option>
                <option value="v80">Velocity 80</option>
                <option value="v100">Velocity 100</option>
                <option value="v127">Velocity 127</option>
              </select>
            </div>
          </div>
          
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <!-- Left comparison panel -->
            <div style="flex: 1; min-width: 300px; background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
              <div id="compare-left-label" style="text-align: center; font-weight: 600; margin-bottom: 8px; color: #1e40af;">Velocity 127</div>
              <div id="compare-left-container" class="spectrogram-scroll-container compare-sync-group" style="border: 2px solid #3b82f6; border-radius: 8px; overflow-x: scroll; overflow-y: hidden; white-space: nowrap; height: 140px; cursor: grab;">
                <img id="compare-left-img" src="static/images/midi_drummer1_1_funk-groove1_138_beat_4-4_bluebird_v127.png" alt="Left Comparison" style="height: 136px; width: auto; display: inline-block; max-width: none;">
              </div>
              <audio id="compare-left-audio" controls style="width: 100%; height: 36px; margin-top: 8px;">
                <source id="compare-left-audio-src" src="static/audio/midi_conditioned/constant_velocity/v=127/drummer1_1_funk-groove1_138_beat_4-4_bluebird_v127.wav" type="audio/wav">
              </audio>
            </div>
            
            <!-- Right comparison panel -->
            <div style="flex: 1; min-width: 300px; background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
              <div id="compare-right-label" style="text-align: center; font-weight: 600; margin-bottom: 8px; color: #27ae60;">MiDiff (Full MIDI)</div>
              <div id="compare-right-container" class="spectrogram-scroll-container compare-sync-group" style="border: 2px solid #27ae60; border-radius: 8px; overflow-x: scroll; overflow-y: hidden; white-space: nowrap; height: 140px; cursor: grab;">
                <img id="compare-right-img" src="static/images/midi_film_conditioned_epoch_50.png" alt="Right Comparison" style="height: 136px; width: auto; display: inline-block; max-width: none;">
              </div>
              <audio id="compare-right-audio" controls style="width: 100%; height: 36px; margin-top: 8px;">
                <source id="compare-right-audio-src" src="static/audio/midi_conditioned/version_86/enhancement/use_midi=True_epoch_50/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav" type="audio/wav">
              </audio>
            </div>
          </div>
          
          <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; align-items: center;">
            <button id="sync-scroll-btn" onclick="toggleSyncScroll()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;">
              <i class="fas fa-link"></i> Sync Scrolling: ON
            </button>
            
            <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 6px 12px; border-radius: 6px; border: 1px solid #ced4da;">
              <span style="font-weight: 600; font-size: 0.85rem; color: #495057;"><i class="fas fa-search"></i> Zoom:</span>
              <button onclick="zoomSpectrogram(-0.25)" style="width: 32px; height: 32px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; cursor: pointer; font-size: 1.1rem; font-weight: bold;">âˆ’</button>
              <span id="zoom-level" style="min-width: 50px; text-align: center; font-weight: 600; color: #495057;">100%</span>
              <button onclick="zoomSpectrogram(0.25)" style="width: 32px; height: 32px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; cursor: pointer; font-size: 1.1rem; font-weight: bold;">+</button>
              <button onclick="resetZoom()" style="padding: 4px 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Reset</button>
            </div>
          </div>
          
          <p style="font-size: 0.8rem; color: #6c757d; text-align: center; margin-top: 0.75rem;"><i class="fas fa-info-circle"></i> Tip: Use mouse wheel while holding <kbd style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; border: 1px solid #ced4da;">Ctrl</kbd> to zoom, or scroll horizontally to pan.</p>
        </div>

        <h2 class="title is-3" style="margin-top: 2rem;">Conclusion</h2>
        <div class="content has-text-justified">
          <p>
            We presented a MIDI-conditioned diffusion model for drum audio enhancement that extends SGMSE with Feature-wise Linear Modulation (FiLM) layers. By incorporating symbolic musical information through a MIDI encoder, our model makes musically-informed enhancement decisions that preserve rhythmic structure and drum timbre. The results demonstrate that the CTC loss-enhanced model achieves consistently lower Frechet VGGish Scores compared to the baseline, with perceptual evaluation confirming superior denoising quality. This work validates the effectiveness of MIDI conditioning for audio enhancement and opens promising directions for extending this approach to other instruments, multi-track scenarios, and real-time applications.
          </p>
        </div>
      </div>
    </div>
  </div>
</section>


<section class="section" id="BibTeX">
    <div class="container is-max-desktop content">
      <h2 class="title">BibTeX</h2>
    <pre><code>@article{aspis2025midiff,
      author    = {Aspis, Elad and Gannot, Sharon},
      title     = {MiDiff: MIDI-Conditioned Diffusion Models for Drum Audio Enhancement},
      journal   = {TBD},
      year      = {2025},
    }</code></pre>
    </div>
</section>


<footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <a class="icon-link" href="#" style="margin: 0 10px;">
        <i class="fas fa-file-pdf fa-lg"></i>
      </a>
      <a class="icon-link" href="#" style="margin: 0 10px;">
        <i class="fab fa-github fa-lg"></i>
      </a>
    </div>
    <div class="columns is-centered">
      <div class="column is-8">
        <div class="content">
          <p>
            <strong>How to Cite:</strong><br>
            Aspis, E., & Gannot, S. (2025). <em>MiDiff: MIDI-Conditioned Diffusion Models for Drum Audio Enhancement</em>.
          </p>
          <p>
            &copy; 2025 Elad Aspis, Bar-Ilan University. All Rights Reserved.
          </p>
          <p>
            <strong>Credits:</strong><br>
            For the website we used the source code from the <a href="https://github.com/nerfies/nerfies.github.io" target="_blank">Nerfies</a> website.
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>

<!-- Statcounter tracking code -->

<!-- You can add a tracker to track page visits by creating an account at statcounter.com -->

    <!-- End of Statcounter Code -->

<script>
// Initialize SeeWav instances for all audio files
document.addEventListener('DOMContentLoaded', function() {
  
  // Configuration for SeeWav waveforms
  const waveConfig = {
    height: 60,
    width: '100%',
    color: '#3273dc',
    progressColor: '#209cee',
    backgroundColor: '#f5f5f5',
    cursorColor: '#363636',
    responsive: true,
    normalize: true,
    pixelRatio: window.devicePixelRatio || 1
  };

  // Function to create SeeWav instance
  function createSeeWav(containerId, audioSrc) {
    const container = document.getElementById(containerId);
    if (!container) return null;
    
    return new SeeWav({
      container: container,
      url: audioSrc,
      ...waveConfig
    });
  }

  // Reference Audio Waveforms
  const cleanWave = createSeeWav('waveform-clean', 'static/clean_10_soul-groove10_102_4-4_bluebird.wav');
  const noisyWave = createSeeWav('waveform-noisy', 'static/noisy_10_soul-groove10_102_4-4_bluebird_v1_noisy.wav');

  // Model Outputs Waveforms - 0 Epochs (Initial)
  const baseline0Wave = createSeeWav('waveform-baseline-0', 'static/baseline_model/epoch0_10_soul-groove10_102_4-4_bluebird_v1_noisy.wav');
  const ctc0Wave = createSeeWav('waveform-ctc-0', 'static/ctc_loss/epoch0_10_soul-groove10_102_4-4_bluebird_v1_noisy.wav');

  // Model Outputs Waveforms - 10 Epochs
  const baseline10Wave = createSeeWav('waveform-baseline-10', 'static/baseline_model/epoch10_10_soul-groove10_102_4-4_bluebird_v1_noisy.wav');
  const ctc10Wave = createSeeWav('waveform-ctc-10', 'static/ctc_loss/epoch10_10_soul-groove10_102_4-4_bluebird_v1_noisy.wav');

  // Model Outputs Waveforms - 20 Epochs
  const baseline20Wave = createSeeWav('waveform-baseline-20', 'static/baseline_model/epoch20_10_soul-groove10_102_4-4_bluebird_v1_noisy.wav');
  const ctc20Wave = createSeeWav('waveform-ctc-20', 'static/ctc_loss/epoch20_10_soul-groove10_102_4-4_bluebird_v1_noisy.wav');

  // Sync waveforms with audio controls
  const audioMappings = [
    { audioId: 'audio-clean', wave: cleanWave },
    { audioId: 'audio-noisy', wave: noisyWave },
    { audioId: 'audio-baseline-0', wave: baseline0Wave },
    { audioId: 'audio-ctc-0', wave: ctc0Wave },
    { audioId: 'audio-baseline-10', wave: baseline10Wave },
    { audioId: 'audio-ctc-10', wave: ctc10Wave },
    { audioId: 'audio-baseline-20', wave: baseline20Wave },
    { audioId: 'audio-ctc-20', wave: ctc20Wave }
  ];

  audioMappings.forEach(({ audioId, wave }) => {
    if (!wave) return;
    
    const audioEl = document.getElementById(audioId);
    if (!audioEl) return;
    
    // Sync audio controls with waveform
    audioEl.addEventListener('play', () => {
      if (wave.play) wave.play();
    });
    
    audioEl.addEventListener('pause', () => {
      if (wave.pause) wave.pause();
    });
    
    audioEl.addEventListener('timeupdate', () => {
      if (wave.seekTo && audioEl.duration) {
        const progress = audioEl.currentTime / audioEl.duration;
        wave.seekTo(progress);
      }
    });

    // Click on waveform to control audio
    if (wave.on) {
      wave.on('click', (progress) => {
        if (audioEl.duration) {
          audioEl.currentTime = progress * audioEl.duration;
        }
      });
      
      wave.on('play', () => {
        audioEl.play();
      });
      
      wave.on('pause', () => {
        audioEl.pause();
      });
    }
  });

  // Alternative approach if SeeWav doesn't have event listeners
  // Add click handlers to waveform containers
  document.querySelectorAll('[id^="waveform-"]').forEach(container => {
    container.addEventListener('click', (e) => {
      const rect = container.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const progress = clickX / rect.width;
      
      // Find corresponding audio element
      const waveformId = container.id;
      const audioId = waveformId.replace('waveform-', 'audio-');
      const audioEl = document.getElementById(audioId);
      
      if (audioEl && audioEl.duration) {
        audioEl.currentTime = progress * audioEl.duration;
      }
    });
  });
});
</script>

<script>
// Function to load CSV data
async function loadCSV(url) {
  const response = await fetch(url);
  const text = await response.text();
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',');
  const data = [];
  
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(',');
    const row = {};
    headers.forEach((header, index) => {
      row[header.trim()] = parseFloat(values[index]) || values[index];
    });
    data.push(row);
  }
  return data;
}


// Initialize the chart
async function initChart() {
  console.log('Starting chart initialization...');
  
  try {
    console.log('Loading CSV files...');
    // Load both CSV files
    const baselineData = await loadCSV('static/graphs/frechet_loss/tensorboard_logs_version_83.csv');
    const ctcData = await loadCSV('static/graphs/frechet_loss/tensorboard_logs_version_86.csv');
    
    console.log('Baseline data:', baselineData.length, 'points');
    console.log('CTC data:', ctcData.length, 'points');
    console.log('Sample baseline data:', baselineData.slice(0, 3));
    console.log('Sample CTC data:', ctcData.slice(0, 3));

    const chartElement = document.getElementById('frechetChart');
    console.log('Chart element found:', chartElement);
    
    if (!chartElement) {
      console.error('Chart element not found!');
      return;
    }

    const ctx = chartElement.getContext('2d');
    console.log('Canvas context:', ctx);
    
    const STEPS_PER_EPOCH = 1102;
    window.frechetChart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Baseline Model',
          data: baselineData.map(row => ({
            x: row.Step / STEPS_PER_EPOCH,
            y: row.Value
          })),
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        }, {
          label: 'Midi Conditioned Model',
          data: ctcData.map(row => ({
            x: row.Step / STEPS_PER_EPOCH,
            y: row.Value
          })),
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'linear',
            title: {
              display: true,
              text: 'Epoch'
            },
            ticks: {
              callback: (value) => {
                // Prefer near-integers; otherwise show one decimal
                const rounded = Math.round(value);
                return Math.abs(value - rounded) < 0.05 ? String(rounded) : value.toFixed(1);
              }
            }
          },
          y: {
            type: 'logarithmic',
            title: {
              display: true,
              text: 'Frechet VGGish Score'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Frechet VGGish Score Comparison During Training'
          },
          legend: {
            display: true,
            position: 'top'
          },
          tooltip: {
            mode: 'point',
            intersect: false,
            callbacks: {
              label: function(context) {
                const epoch = context.parsed.x;
                return `${context.dataset.label}: ${context.parsed.y.toFixed(4)} (Epoch: ${epoch.toFixed(0)})`;
              }
            }
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        }
      }
    });
    
    console.log('Chart created successfully:', window.frechetChart);
  } catch (error) {
    console.error('Error loading chart data:', error);
    document.getElementById('frechetChart').parentElement.innerHTML = 
      '<p style="text-align: center; color: red;">Error loading chart data: ' + error.message + '</p>';
  }
}

// Toggle logarithmic scale
function toggleLogScale() {
  const checkbox = document.getElementById('logScaleToggle');
  if (window.frechetChart) {
    window.frechetChart.options.scales.y.type = checkbox.checked ? 'logarithmic' : 'linear';
    window.frechetChart.update();
  }
}

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', initChart);
</script>

<script>
// Initialize Velocity Ablation bar chart in Impact section
document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('velocityAblationChart');
  if (!canvas || !window.Chart) return;

  const labels = ['Baseline', 'MiDiff', 'MiDiff (Random Velocity)', '0', '1', '20', '40', '60', '80', '100', '127'];
  const baseline =      [0.4797, null,   null,                     null, null,  null,  null,  null,  null,  null,   null];
  const midiff =        [null,   0.3923, null,                     null, null,  null,  null,  null,  null,  null,   null];
  const randomVel =     [null,   null,   1.7646,                   null, null,  null,  null,  null,  null,  null,   null];
  const constantVel =   [null,   null,   null,                     1.8654, 1.7758, 0.7177, 0.5352, 0.4843, 0.4262, 0.4298, 0.4446];

  const ctx = canvas.getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Baseline (No MIDI)', data: baseline, backgroundColor: 'rgba(231, 76, 60, 0.85)' },
        { label: 'MiDiff', data: midiff, backgroundColor: 'rgba(39, 174, 96, 0.85)' },
        { label: 'MiDiff (Random Velocity)', data: randomVel, backgroundColor: 'rgba(230, 126, 34, 0.85)' },
        { label: 'MiDiff (Constant Velocity)', data: constantVel, backgroundColor: 'rgba(52, 152, 219, 0.85)' }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display: true, text: 'Velocity Configuration' },
          ticks: { 
            minRotation: 45, 
            maxRotation: 45,
            autoSkip: false,
            maxTicksLimit: 20,
            padding: 5
          },
          grid: { display: false },
          offset: true
        },
        y: {
          beginAtZero: true,
          min: 0,
          max: 2,
          title: { display: true, text: 'FAD Score (â†“ lower is better)' },
          grid: { borderDash: [4, 4] }
        }
      },
      plugins: {
        legend: { position: 'right' },
        title: { display: true, text: 'Velocity Ablation: FAD Score' },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const v = ctx.parsed.y;
              if (v == null) return null;
              return `${ctx.dataset.label}: ${v.toFixed(4)}`;
            }
          }
        }
      }
    }
  });
});
</script>

<style>
  /* Arrow pulse animation */
  @keyframes pulse-arrow {
    0%, 100% {
      transform: scale(1);
      opacity: 0.9;
    }
    50% {
      transform: scale(1.1);
      opacity: 1;
    }
  }

  /* MIDI Player Consistent Styling */
  midi-player {
    width: 100% !important;
    height: 40px !important;
    max-height: 40px !important;
    min-height: 40px !important;
    border-radius: 8px !important;
    display: block !important;
    margin: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
    font-size: 12px !important;
  }
  
  /* Target internal elements of midi-player */
  midi-player::part(control-panel) {
    height: 40px !important;
    max-height: 40px !important;
  }

  /* Force MIDI player field and control to have no extra spacing */
  .box .field .control midi-player {
    line-height: 40px !important;
  }
  
  .box .field .control {
    padding: 0 !important;
    margin: 0 !important;
  }

  /* Remove extra spacing from Bulma's field class in audio reference boxes */
  .box .field:last-child {
    margin-bottom: 0 !important;
  }

  /* Make all three reference cards equal height */
  .columns.is-centered > .column.is-4 {
    display: flex !important;
  }
  
  .columns.is-centered > .column.is-4 > .box {
    display: flex !important;
    flex-direction: column !important;
    width: 100% !important;
    min-height: 100% !important;
  }

  /* Responsive Design Adjustments */
  @media (max-width: 768px) {
    .container {
      padding: 0 15px;
    }
    
    .title.is-1 {
      font-size: 2.5rem;
    }
    
    .title.is-2 {
      font-size: 2rem;
    }
    
    .title.is-3 {
      font-size: 1.75rem;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    .columns {
      flex-direction: column;
    }
    
    .column {
      width: 100%;
    }
    
    #chart-container {
      height: 300px;
    }
  }
</style>

<script>
// Drag-to-scroll functionality for spectrogram containers
document.addEventListener('DOMContentLoaded', function() {
  const spectrogramContainers = document.querySelectorAll('.spectrogram-scroll-container');
  
  spectrogramContainers.forEach(container => {
    let isDown = false;
    let startX;
    let scrollLeft;
    
    container.addEventListener('mousedown', (e) => {
      isDown = true;
      container.style.cursor = 'grabbing';
      startX = e.pageX - container.offsetLeft;
      scrollLeft = container.scrollLeft;
      e.preventDefault();
    });
    
    container.addEventListener('mouseleave', () => {
      isDown = false;
      container.style.cursor = 'grab';
    });
    
    container.addEventListener('mouseup', () => {
      isDown = false;
      container.style.cursor = 'grab';
    });
    
    container.addEventListener('mousemove', (e) => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - container.offsetLeft;
      const walk = (x - startX) * 2; // Scroll speed multiplier
      container.scrollLeft = scrollLeft - walk;
    });
  });
});

// Force MathJax to typeset when page loads
document.addEventListener('DOMContentLoaded', function() {
  if (window.MathJax) {
    MathJax.typesetPromise().then(() => {
      console.log('MathJax typesetting complete');
    }).catch((err) => console.log('MathJax typesetting failed: ', err));
  } else {
    // Wait for MathJax to load
    setTimeout(() => {
      if (window.MathJax) {
        MathJax.typesetPromise().then(() => {
          console.log('MathJax typesetting complete (delayed)');
        }).catch((err) => console.log('MathJax typesetting failed: ', err));
      }
    }, 2000);
  }
});

// Spectrogram Comparison Tool functionality
const spectrogramData = {
  midiff: {
    label: 'MiDiff (Full MIDI)',
    img: 'static/images/midi_film_conditioned_epoch_50.png',
    audio: 'static/audio/midi_conditioned/version_86/enhancement/use_midi=True_epoch_50/drummer1_1_funk-groove1_138_beat_4-4_bluebird.wav'
  },
  v0: {
    label: 'Velocity 0',
    img: 'static/images/midi_drummer1_1_funk-groove1_138_beat_4-4_bluebird_v0.png',
    audio: 'static/audio/midi_conditioned/constant_velocity/v=0/drummer1_1_funk-groove1_138_beat_4-4_bluebird_v0.wav'
  },
  v1: {
    label: 'Velocity 1',
    img: 'static/images/midi_drummer1_1_funk-groove1_138_beat_4-4_bluebird_v1.png',
    audio: 'static/audio/midi_conditioned/constant_velocity/v=1/drummer1_1_funk-groove1_138_beat_4-4_bluebird_v1.wav'
  },
  v20: {
    label: 'Velocity 20',
    img: 'static/images/midi_drummer1_1_funk-groove1_138_beat_4-4_bluebird_v20.png',
    audio: 'static/audio/midi_conditioned/constant_velocity/v=20/drummer1_1_funk-groove1_138_beat_4-4_bluebird_v20.wav'
  },
  v40: {
    label: 'Velocity 40',
    img: 'static/images/midi_drummer1_1_funk-groove1_138_beat_4-4_bluebird_v40.png',
    audio: 'static/audio/midi_conditioned/constant_velocity/v=40/drummer1_1_funk-groove1_138_beat_4-4_bluebird_v40.wav'
  },
  v60: {
    label: 'Velocity 60',
    img: 'static/images/midi_drummer1_1_funk-groove1_138_beat_4-4_bluebird_v60.png',
    audio: 'static/audio/midi_conditioned/constant_velocity/v=60/drummer1_1_funk-groove1_138_beat_4-4_bluebird_v60.wav'
  },
  v80: {
    label: 'Velocity 80',
    img: 'static/images/midi_drummer1_1_funk-groove1_138_beat_4-4_bluebird_v80.png',
    audio: 'static/audio/midi_conditioned/constant_velocity/v=80/drummer1_1_funk-groove1_138_beat_4-4_bluebird_v80.wav'
  },
  v100: {
    label: 'Velocity 100',
    img: 'static/images/midi_drummer1_1_funk-groove1_138_beat_4-4_bluebird_v100.png',
    audio: 'static/audio/midi_conditioned/constant_velocity/v=100/drummer1_1_funk-groove1_138_beat_4-4_bluebird_v100.wav'
  },
  v127: {
    label: 'Velocity 127',
    img: 'static/images/midi_drummer1_1_funk-groove1_138_beat_4-4_bluebird_v127.png',
    audio: 'static/audio/midi_conditioned/constant_velocity/v=127/drummer1_1_funk-groove1_138_beat_4-4_bluebird_v127.wav'
  }
};

let syncScrollEnabled = true;
let currentZoom = 1.0;
const MIN_ZOOM = 1.0;
const MAX_ZOOM = 4.0;

function zoomSpectrogram(delta) {
  const newZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, currentZoom + delta));
  if (newZoom !== currentZoom) {
    currentZoom = newZoom;
    applyZoom();
  }
}

function resetZoom() {
  currentZoom = 1.0;
  applyZoom();
}

function applyZoom() {
  const leftImg = document.getElementById('compare-left-img');
  const rightImg = document.getElementById('compare-right-img');
  const zoomLabel = document.getElementById('zoom-level');
  
  if (leftImg) {
    leftImg.style.height = `${136 * currentZoom}px`;
  }
  if (rightImg) {
    rightImg.style.height = `${136 * currentZoom}px`;
  }
  if (zoomLabel) {
    zoomLabel.textContent = `${Math.round(currentZoom * 100)}%`;
  }
  
  // Adjust container height for larger zoom levels
  const leftContainer = document.getElementById('compare-left-container');
  const rightContainer = document.getElementById('compare-right-container');
  const newHeight = Math.min(400, 140 * currentZoom);
  
  if (leftContainer) {
    leftContainer.style.height = `${newHeight}px`;
  }
  if (rightContainer) {
    rightContainer.style.height = `${newHeight}px`;
  }
}

function updateComparison(side) {
  const selectId = `compare-${side}`;
  const select = document.getElementById(selectId);
  const value = select.value;
  const data = spectrogramData[value];
  
  if (data) {
    document.getElementById(`compare-${side}-label`).textContent = data.label;
    document.getElementById(`compare-${side}-img`).src = data.img;
    
    const audio = document.getElementById(`compare-${side}-audio`);
    const audioSrc = document.getElementById(`compare-${side}-audio-src`);
    audioSrc.src = data.audio;
    audio.load();
  }
}

function toggleSyncScroll() {
  syncScrollEnabled = !syncScrollEnabled;
  const btn = document.getElementById('sync-scroll-btn');
  if (syncScrollEnabled) {
    btn.innerHTML = '<i class="fas fa-link"></i> Sync Scrolling: ON';
    btn.style.background = '#3b82f6';
  } else {
    btn.innerHTML = '<i class="fas fa-unlink"></i> Sync Scrolling: OFF';
    btn.style.background = '#6c757d';
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Setup comparison dropdowns
  const leftSelect = document.getElementById('compare-left');
  const rightSelect = document.getElementById('compare-right');
  
  if (leftSelect) {
    leftSelect.addEventListener('change', () => updateComparison('left'));
  }
  if (rightSelect) {
    rightSelect.addEventListener('change', () => updateComparison('right'));
  }
  
  // Setup synchronized scrolling for comparison containers
  const leftContainer = document.getElementById('compare-left-container');
  const rightContainer = document.getElementById('compare-right-container');
  
  if (leftContainer && rightContainer) {
    let isScrolling = false;
    
    leftContainer.addEventListener('scroll', function() {
      if (syncScrollEnabled && !isScrolling) {
        isScrolling = true;
        const scrollRatio = this.scrollLeft / (this.scrollWidth - this.clientWidth);
        rightContainer.scrollLeft = scrollRatio * (rightContainer.scrollWidth - rightContainer.clientWidth);
        setTimeout(() => { isScrolling = false; }, 10);
      }
    });
    
    rightContainer.addEventListener('scroll', function() {
      if (syncScrollEnabled && !isScrolling) {
        isScrolling = true;
        const scrollRatio = this.scrollLeft / (this.scrollWidth - this.clientWidth);
        leftContainer.scrollLeft = scrollRatio * (leftContainer.scrollWidth - leftContainer.clientWidth);
        setTimeout(() => { isScrolling = false; }, 10);
      }
    });
    
    // Mouse wheel zoom with Ctrl key
    const handleWheelZoom = function(e) {
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        zoomSpectrogram(delta);
      }
    };
    
    leftContainer.addEventListener('wheel', handleWheelZoom, { passive: false });
    rightContainer.addEventListener('wheel', handleWheelZoom, { passive: false });
  }
  
  // Synchronized scrolling for velocity cards
  const velocityContainers = document.querySelectorAll('.velocity-scroll-group');
  if (velocityContainers.length > 0) {
    let isVelocityScrolling = false;
    
    velocityContainers.forEach(container => {
      container.addEventListener('scroll', function() {
        if (!isVelocityScrolling) {
          isVelocityScrolling = true;
          const scrollRatio = this.scrollLeft / (this.scrollWidth - this.clientWidth);
          velocityContainers.forEach(other => {
            if (other !== this) {
              other.scrollLeft = scrollRatio * (other.scrollWidth - other.clientWidth);
            }
          });
          setTimeout(() => { isVelocityScrolling = false; }, 10);
        }
      });
    });
  }
});
</script>

  </body>
  </html>
